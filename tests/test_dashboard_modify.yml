---
- name: Test Dashboard Save, Modify, and Upload
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    base_url: "{{ base_url | default('http://localhost:3000') }}"
    org: "{{ org | default('testorg') }}"
    cluster: "{{ cluster | default('test-cluster') }}"
    dashboard_name: "{{ dashboard_name | default('Overview') }}"

  tasks:
    # Step 1: Fetch the existing dashboard from the API
    - name: Fetch existing dashboard from AxonOps API
      uri:
        url: "{{ base_url }}/api/v1/dashboardtemplate/{{ org }}/cassandra/{{ cluster }}?dashver=2.0"
        method: GET
        headers: "{{ {'Authorization': 'Bearer ' + lookup('env', 'AXONOPS_TOKEN')} if lookup('env', 'AXONOPS_TOKEN') else {} }}"
        user: "{{ lookup('env', 'AXONOPS_USERNAME') if not lookup('env', 'AXONOPS_TOKEN') else omit }}"
        password: "{{ lookup('env', 'AXONOPS_PASSWORD') if not lookup('env', 'AXONOPS_TOKEN') else omit }}"
        force_basic_auth: "{{ true if not lookup('env', 'AXONOPS_TOKEN') else false }}"
        return_content: true
        status_code: 200
      register: api_response

    - name: Extract the target dashboard
      set_fact:
        original_dashboard: "{{ api_response.json.dashboards | selectattr('name', 'equalto', dashboard_name) | first }}"
      when: api_response.json.dashboards | selectattr('name', 'equalto', dashboard_name) | list | length > 0

    - name: Verify dashboard exists
      assert:
        that:
          - original_dashboard is defined
          - original_dashboard.name == dashboard_name
        fail_msg: "Dashboard '{{ dashboard_name }}' not found"
        success_msg: "‚úÖ Step 1 PASSED - Dashboard '{{ dashboard_name }}' retrieved"

    - name: Display original dashboard info
      debug:
        msg:
          - "Dashboard: {{ original_dashboard.name }}"
          - "Number of panels: {{ original_dashboard.panels | length }}"
          - "Number of filters: {{ original_dashboard.filters | length }}"

    # Step 2: Modify the dashboard (update first line-chart panel with epoch time)
    - name: Get current epoch time
      shell: date +%s
      register: epoch_result
      changed_when: false

    - name: Set epoch time fact
      set_fact:
        epoch_time: "{{ epoch_result.stdout }}"

    - name: Find first line-chart panel
      set_fact:
        first_linechart_panel: "{{ original_dashboard.panels | selectattr('type', 'equalto', 'line-chart') | first }}"

    - name: Create modified version with updated first line-chart panel title
      set_fact:
        modified_panels: "{{ modified_panels | default([]) + [panel_item | combine({'title': panel_item.title + ' - ' + epoch_time}) if panel_item.type == 'line-chart' and panel_item.uuid == first_linechart_panel.uuid else panel_item] }}"
      loop: "{{ original_dashboard.panels }}"
      loop_control:
        loop_var: panel_item

    - name: Display modification info
      debug:
        msg:
          - "‚úÖ Step 2 PASSED - Dashboard modified"
          - "Original first line-chart panel title: {{ first_linechart_panel.title }}"
          - "Modified first line-chart panel title: {{ first_linechart_panel.title }} - {{ epoch_time }}"

    # Step 3: Upload the modified dashboard (overwriting the original)
    - name: Upload modified dashboard (overwriting original)
      axonops.axonops.dashboard_template:
        base_url: "{{ base_url }}"
        org: "{{ org }}"
        cluster: "{{ cluster }}"
        name: "{{ dashboard_name }}"
        filters: "{{ original_dashboard.filters }}"
        panels: "{{ modified_panels }}"
        auth_token: "{{ lookup('env', 'AXONOPS_TOKEN') | default(omit) }}"
        username: "{{ lookup('env', 'AXONOPS_USERNAME') | default(omit) }}"
        password: "{{ lookup('env', 'AXONOPS_PASSWORD') | default(omit) }}"
      register: upload_result

    - name: Verify upload was successful
      assert:
        that:
          - upload_result.changed == true
        fail_msg: "Dashboard upload should have resulted in a change"
        success_msg: "‚úÖ Step 3 PASSED - Modified dashboard uploaded successfully"

    # Step 4: Re-fetch and verify the modified dashboard
    - name: Verify modified dashboard exists in API
      uri:
        url: "{{ base_url }}/api/v1/dashboardtemplate/{{ org }}/cassandra/{{ cluster }}?dashver=2.0"
        method: GET
        headers: "{{ {'Authorization': 'Bearer ' + lookup('env', 'AXONOPS_TOKEN')} if lookup('env', 'AXONOPS_TOKEN') else {} }}"
        user: "{{ lookup('env', 'AXONOPS_USERNAME') if not lookup('env', 'AXONOPS_TOKEN') else omit }}"
        password: "{{ lookup('env', 'AXONOPS_PASSWORD') if not lookup('env', 'AXONOPS_TOKEN') else omit }}"
        force_basic_auth: "{{ true if not lookup('env', 'AXONOPS_TOKEN') else false }}"
        return_content: true
        status_code: 200
      register: verify_response

    - name: Extract the modified dashboard
      set_fact:
        uploaded_dashboard: "{{ verify_response.json.dashboards | selectattr('name', 'equalto', dashboard_name) | first }}"
      when: verify_response.json.dashboards | selectattr('name', 'equalto', dashboard_name) | list | length > 0

    - name: Verify modified dashboard was uploaded correctly
      assert:
        that:
          - uploaded_dashboard is defined
          - (uploaded_dashboard.panels | selectattr('type', 'equalto', 'line-chart') | first).title is search(epoch_time)
        fail_msg: "Modified dashboard not found or panel title doesn't match"
        success_msg: "‚úÖ Step 4 PASSED - Modified dashboard verified in API"

    # Summary
    - name: Test Summary
      debug:
        msg:
          - "================================================"
          - "üéâ Dashboard Modify Test PASSED!"
          - "================================================"
          - "‚úÖ Step 1: Retrieved '{{ dashboard_name }}' dashboard"
          - "‚úÖ Step 2: Modified first line-chart panel title with epoch time"
          - "‚úÖ Step 3: Uploaded modified dashboard (overwriting original)"
          - "‚úÖ Step 4: Verified modification in API"
          - ""
          - "‚ö†Ô∏è  Note: The original '{{ dashboard_name }}' dashboard has been modified"
          - "   First line-chart panel title changed to: {{ first_linechart_panel.title }} - {{ epoch_time }}"
